<!DOCTYPE html>
<html>
<head>
<title>KP Cuspal Research Tool</title>

<style>
/* =========================================================
   TANTRIC FIRE ‚Äì OCCULT POWER THEME
   Dark ‚Ä¢ Saffron ‚Ä¢ Gold ‚Ä¢ Ritual Glow
   ========================================================= */

:root{
    --bg-main: radial-gradient(circle at top, #1b0a0a, #070303 70%);
    --panel-bg: #120606;
    --border-gold: #a86b17;
    --border-soft: #3a1a12;

    --text-main: #f3e8d0;
    --text-dim: #c7b38a;

    --accent-saffron: #ff9f1c;
    --accent-fire: #ff6a00;
    --accent-crimson: #b11226;

    --table-head-bg: linear-gradient(180deg, #2a0f0f, #140707);
    --table-row-hover: rgba(255,159,28,0.08);

    --btn-bg: linear-gradient(135deg, #ff9f1c, #b11226);
    --btn-hover: linear-gradient(135deg, #ffb347, #d4142a);

    --glow: 0 0 12px rgba(255,159,28,0.35);
}

/* ---------- BODY ---------- */
body{
    background: var(--bg-main);
    color: var(--text-main);
    font-family: "Segoe UI", Arial, sans-serif;
    padding: 20px;
}

/* ---------- HEADINGS ---------- */
h2{
    color: var(--accent-saffron);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 30px;
    text-shadow: 0 0 8px rgba(255,159,28,0.5);
}

/* ---------- TABLE ---------- */
table{
    border-collapse: collapse;
    width: 100%;
    margin-top: 16px;
    background: var(--panel-bg);
    border: 1px solid var(--border-gold);
    box-shadow: var(--glow);
}

th, td{
    border: 1px solid var(--border-soft);
    padding: 8px;
    text-align: center;
    font-size: 14px;
}

/* ---------- TABLE HEADER ---------- */
th{
    background: var(--table-head-bg);
    color: #ffd27d;
    font-weight: 600;
}

/* ---------- TABLE ROW HOVER ---------- */
tr:hover td{
    background: var(--table-row-hover);
}

/* ---------- SELECT / INPUT ---------- */
select{
    background: #1a0808;
    color: var(--text-main);
    border: 1px solid var(--border-gold);
    padding: 6px;
    outline: none;
}

select:focus{
    box-shadow: var(--glow);
    border-color: var(--accent-saffron);
}

select option{
    background: #120606;
    color: var(--text-main);
}

/* ---------- BUTTONS ---------- */
button{
    background: var(--btn-bg);
    border: none;
    color: #1a0606;
    padding: 7px 14px;
    margin: 6px;
    cursor: pointer;
    font-weight: 600;
    letter-spacing: 0.5px;
    box-shadow: var(--glow);
    transition: all 0.25s ease;
}

button:hover{
    background: var(--btn-hover);
    transform: translateY(-1px);
    box-shadow: 0 0 18px rgba(255,159,28,0.6);
}

/* ---------- CHECKBOX ---------- */
input[type="checkbox"]{
    accent-color: var(--accent-saffron);
}

/* ---------- HIDDEN ---------- */
.hidden{
    display: none;
}

/* ---------- SECTION SPACING ---------- */
#output, #table3, #table4{
    margin-top: 30px;
}

/* ---------- OCCULT DIVIDER EFFECT ---------- */
hr{
    border: none;
    height: 1px;
    background: linear-gradient(
        90deg,
        transparent,
        var(--accent-saffron),
        transparent
    );
    margin: 25px 0;
}

/* =========================================================
   PERSON NAME INPUT ‚Äì DARK MODE FIX
   ========================================================= */
#personName{
    background:#020617;          /* black / dark */
    color:#f8fafc;               /* light text */
    border:1px solid #334155;    /* same as other inputs */
    border-radius:6px;
}

#personName::placeholder{
    color:#64748b;               /* muted placeholder */
}

#personName:focus{
    outline:none;
    box-shadow:0 0 0 1px #facc15; /* gold focus like theme */
}





</style>

<style>
/* TABLE-1 HEADING SIZE BALANCE */
#inputTable th{
    font-size:15.5px;
    font-weight:800;
    letter-spacing:0.6px;
}
</style>





</head>

<body>







<!-- =========================================================
     MAIN HEADING
     ========================================================= -->











<h2>DONNIE DARSSHAN RESEARCH TOOL FOR CUSPAL INTERLINK</h2>

<label style="display:block;margin:10px 0;font-weight:600">
Person Name :
<input
  type="text"
  id="personName"
  placeholder="ENTER NAME (CAPS ONLY)"
  oninput="this.value = this.value.toUpperCase().replace(/[^A-Z\s]/g,'')"
  style="margin-left:8px;padding:4px 6px"
/>
</label>

<label>
<input type="checkbox" id="manualMode" checked>
Manual Cusps (unchecked = Equal cusps from Lagna)
</label>

<button onclick="autoFillSigns()">Auto Fill Signs (From Lagna)</button>

<h3 style="
    margin-top:10px;
    margin-bottom:10px;
    text-align:center;
    color:#ff9f1c;
    font-weight:900;
    letter-spacing:3.2px;
    font-size:33px;
">
CUSP DATA &amp; PLANETS DATA INPUT TABLE-1
</h3>





<table id="inputTable">
<tr>
<th>Bhava / Planet</th>
<th>Zodiac Sign</th>
<th>Degree</th>
<th>Minute</th>
<th>Second</th>
</tr>
</table>


<!-- =========================================================
     C1‚ÄìC200 : BASE DATE & TIME (PRE-BUILD ‚Äì LOCK ONLY)
     ========================================================= -->

<style>
#baseTimeBox{
    background:#120606;
    border:2px solid #a86b17;
    padding:14px 18px;
    margin:16px 0 14px;
    display:flex;
    flex-wrap:wrap;
    gap:18px;
    align-items:center;
    color:#f3e8d0;
    font-weight:700;
}
#baseTimeBox input{
    background:#070303;
    color:#ff9f1c;
    border:1px solid #a86b17;
    padding:6px 10px;
    font-weight:700;
}
</style>

<div id="baseTimeBox">
    <div>
        üìÖ Date of Birth<br>
        <input type="date" id="baseDate">
    </div>
    <div>
        ‚è± Time of Birth<br>
        <input type="time" id="baseTimeLock" step="1">
    </div>
</div>

<script>
/* =========================================================
   C210 : BASE DATE‚ÄìTIME STORE
   ========================================================= */
let BASE_EPOCH = null;

/* =========================================================
   C220 : LOCK BASE DATE‚ÄìTIME (CALLED BY BUILD)
   ========================================================= */

function lockBaseDateTime(){

    /* do nothing if already locked */
    if(BASE_EPOCH) return true;

    let d = document.getElementById("baseDate").value;
    let t = document.getElementById("baseTimeLock").value;

    /* OPTIONAL: only store if both exist */
    if(d && t){
        BASE_EPOCH = new Date(d + "T" + t);

        /* lock only if filled */
        document.getElementById("baseDate").disabled = true;
        document.getElementById("baseTimeLock").disabled = true;
    }

    /* ALWAYS allow build */
    return true;
}


</script>

<!-- =========================================================
     BUILD BUTTONS (UNCHANGED)
     ========================================================= -->

<button onclick="buildCuspalChart()">Build Cuspal Chart</button>
<button onclick="saveJSON()">Save</button>
<button onclick="loadJSON()">Load</button>
<button onclick="loadSwissJSON()">Load Swiss Ephemeris</button>
<button onclick="clearAll()">Clear All</button>


<!-- REQUIRED OUTPUT CONTAINER -->
<div id="output"></div>






























<!-- =========================================================
     KUNDALI
     ========================================================= -->







<!-- =========================================================
     D1 RƒÄ≈öI KUNDALI ‚Äì FINAL (CUSPS ADD-ON SAFE)
     ========================================================= -->

<style>
#kundaliControls{
    display:flex;
    justify-content:center;
    gap:22px;
    margin:22px 0 30px;
    flex-wrap:wrap;
    font-weight:700;
}
#kundaliZone{display:flex;justify-content:center}
.kWrap{display:flex;flex-direction:column;align-items:center;gap:10px}
.kTitle{
    color:#ff9f1c;font-weight:900;letter-spacing:1.6px;
    text-shadow:0 0 10px rgba(255,159,28,.55)
}
.kChart{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    grid-template-rows:repeat(4,1fr);
    width:540px;aspect-ratio:1/1;
    background:radial-gradient(circle at top,#1b0a0a,#070303 70%);
    border:2px solid #a86b17;
    box-shadow:0 0 30px rgba(255,159,28,.35)
}
.kCell{border:1px solid #3a1a12;padding:22px 10px;font-size:13px;position:relative}
.kCell .hnum{position:absolute;top:4px;left:6px;font-size:14px;font-weight:900;color:#facc15}
.kCell .plist{display:flex;flex-direction:column;gap:4px;margin-top:18px;margin-bottom:20px;white-space:nowrap}
.kCell .sign{position:absolute;bottom:4px;right:6px;font-size:13px;font-weight:800;color:#ff9f1c}
.kBlank{background:#0c0404;border:1px solid #2a0f0f}
</style>

<div id="kundaliControls">
    <label>Pivot :
        <select id="kPivot">
            <option value="Lagna">Lagna</option>
            <option value="Surya">Surya</option>
            <option value="Chandra">Chandra</option>
            <option value="Mangala">Mangala</option>
            <option value="Rahu">Rahu</option>
            <option value="Jupiter">Guru</option>
            <option value="Saturn">Saturn</option>
            <option value="Budha">Budha</option>
            <option value="Ketu">Ketu</option>
            <option value="Venus">Venus</option>
        </select>
    </label>
    <label><input type="checkbox" id="kpModeK"> KP (0¬∞)</label>
    <label><input type="checkbox" id="vedicModeK"> Vedic (15¬∞)</label>
    <label><input type="checkbox" id="retroModeK"> Retro</label>

    <!-- üî• ADDITION ONLY -->
    <label>
        <input type="checkbox" id="showCuspsD1">
        Show Cusps (2‚Äì12)
    </label>
</div>

<div id="kundaliZone">
    <div class="kWrap">
        <div class="kTitle">D1 ‚Äì RƒÄ≈öI</div>
        <div id="D1Chart" class="kChart"></div>
    </div>
</div>

<script>
const SI_SIGNS=[
 "Pisces","Aries","Taurus","Gemini",
 "Aquarius","","","Cancer",
 "Capricorn","","","Leo",
 "Sagittarius","Scorpio","Libra","Virgo"
];
const HOUSE_FLOW=[12,1,2,3,11,0,0,4,10,0,0,5,9,8,7,6];
const DESC_SIGNS=["Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];

function initChart(){
    let el=document.getElementById("D1Chart"); el.innerHTML="";
    SI_SIGNS.forEach((s,i)=>{
        el.innerHTML+=s?
        `<div class="kCell" data-sign="${s}" data-idx="${i}">
            <div class="hnum"></div><div class="plist"></div><div class="sign">${s}</div>
        </div>`:`<div class="kCell kBlank"></div>`;
    });
}

function absDeg(p){
    return absoluteDeg(
        signs.indexOf(document.getElementById(p+"_sign").value),
        document.getElementById(p+"_deg").value,
        document.getElementById(p+"_min").value,
        document.getElementById(p+"_sec").value
    );
}

function splitDMS(abs){
    let a=((abs%360)+360)%360;
    let d=Math.floor((a%30)+1e-9);
    let mf=(a%1)*60;
    let m=Math.floor(mf+1e-9);
    let s=Math.floor(((mf-m)*60)+1e-9);
    return {d,m,s};
}

/* =========================================================
   RETRO HOUSE LOGIC (KUNDALI ONLY)
   ========================================================= */
function retroHouse(h){
    return ((14 - h - 1) % 12) + 1;
}

function drawD1(){
    document.querySelectorAll("#D1Chart .plist").forEach(p=>p.innerHTML="");
    document.querySelectorAll("#D1Chart .hnum").forEach(h=>h.innerHTML="");

    let pivot=kPivot.value;
    let showNums=kpModeK.checked||vedicModeK.checked;
    let retro=retroModeK.checked;

    let pSign,pAbs;

    if(pivot==="Lagna"){
        pSign=document.getElementById("c1_sign").value;
        pAbs=absDeg("c1");
    }else{
        pSign=document.getElementById(pivot+"_sign").value;
        pAbs=absDeg(pivot);
    }

    let pivotAbs;
    if(kpModeK.checked){
        pivotAbs=(signs.indexOf(pSign)-1)*30;
    }else if(vedicModeK.checked){
        pivotAbs=(signs.indexOf(pSign)-1)*30+15;
    }else{
        pivotAbs=pAbs;
    }

    if(showNums){
        let lagIdx=[...document.querySelectorAll("#D1Chart [data-sign]")]
            .find(c=>c.dataset.sign===pSign)?.dataset.idx;
        document.querySelectorAll("#D1Chart [data-sign]").forEach(c=>{
            let b=HOUSE_FLOW[c.dataset.idx];
            if(b){
                let h=((b-HOUSE_FLOW[lagIdx]+12)%12)+1;
                c.querySelector(".hnum").textContent =
                    retro ? retroHouse(h) : h;
            }
        });
    }

    let buckets={};

    function place(lbl,abs,isPivot=false,isMirror=false){
        let shifted;
        if(isPivot){
            shifted=pivotAbs;
        }else if(isMirror){
            shifted=(pivotAbs+180)%360;
        }else{
            shifted=(abs-pAbs+pivotAbs+360)%360;
        }

        let sign=signs[Math.floor(shifted/30)+1];
        let {d,m,s}=isPivot&&!kpModeK.checked&&!vedicModeK.checked
            ? splitDMS(abs)
            : splitDMS(shifted);

        buckets[sign]=buckets[sign]||[];
        buckets[sign].push({
		deg:d,
		text:`${markPlanet(lbl)} ${d}¬∞${m}'${s}"`
	});

    }

    planets.forEach(p=>{
        if(p==="Ketu"&&pivot==="Rahu") place("Ketu",absDeg("Ketu"),false,true);
        else if(p==="Rahu"&&pivot==="Ketu") place("Rahu",absDeg("Rahu"),false,true);
        else place(p,absDeg(p),p===pivot);
    });

    if(pivot==="Lagna") place("Lagna",absDeg("c1"),true);

    /* ===============================
       CUSP DISPLAY (ADD-ON ONLY)
       =============================== */
    if(document.getElementById("showCuspsD1")?.checked){
        for(let i=2;i<=12;i++){
            let abs = absDeg("c"+i);
            let sign = signs[Math.floor(((abs%360)+360)%360/30)+1];
            let {d,m,s} = splitDMS(abs);
            buckets[sign]=buckets[sign]||[];
            buckets[sign].push({
                deg:d,
                text:`Cusp ${i} ${d}¬∞${m}'${s}"`
            });
        }
    }

    Object.keys(buckets).forEach(sign=>{
        let list=buckets[sign];
        list.sort((a,b)=>DESC_SIGNS.includes(sign)?b.deg-a.deg:a.deg-b.deg);
        document.querySelectorAll(`#D1Chart [data-sign='${sign}'] .plist`)
            .forEach(p=>list.forEach(x=>{
                let d=document.createElement("div");
                d.textContent=x.text;
                p.appendChild(d);
            }));
    });
}

initChart();
[kPivot,kpModeK,vedicModeK,retroModeK,showCuspsD1].forEach(e=>{
    e.onchange=()=>{
        if(e===kpModeK) vedicModeK.checked=false;
        if(e===vedicModeK) kpModeK.checked=false;
        drawD1();
    };
});
document.querySelector("button[onclick='buildCuspalChart()']")
 ?.addEventListener("click",()=>setTimeout(drawD1,0));

drawD1();
</script>

























<!-- =========================================================
     PART X : RETRO COUNTER TABLE (FINAL ‚Äì PIVOT LOCKED TO 1)
     ========================================================= -->

<style>
#retroCounterWrap{
    display:flex;
    justify-content:center;
    margin-top:25px;
}

#retroCounter{
    background:#120606;
    border:1px solid #a86b17;
    box-shadow:0 0 18px rgba(255,159,28,.35);
    padding:12px;
    margin-left:25px;
}

#retroCounter h3{
    text-align:center;
    color:#ff9f1c;
    letter-spacing:1px;
    margin-bottom:10px;
    text-shadow:0 0 8px rgba(255,159,28,.6);
}

#retroCounter table{
    border-collapse:collapse;
    min-width:220px;
}

#retroCounter th,
#retroCounter td{
    border:1px solid #3a1a12;
    padding:6px 10px;
    text-align:center;
}

#retroCounter th{
    background:linear-gradient(180deg,#2a0f0f,#140707);
    color:#ffd27d;
}
</style>

<script>
/* =========================================================
   RETRO COUNTER ‚Äì FINAL CORRECT ENGINE
   ========================================================= */

/* ---------- Absolute degree of Lagna / planet ---------- */
function getAbsEntityRC(name){
    if(name === "Lagna"){
        return absoluteDeg(
            signs.indexOf(document.getElementById("c1_sign").value),
            document.getElementById("c1_deg").value,
            document.getElementById("c1_min").value,
            document.getElementById("c1_sec").value
        );
    }
    return getPlanetAbsDeg(name);
}

/* =========================================================
   RETRO HOUSE CALCULATION (FIXED FOR VEDIC ¬±15¬∞)
   ========================================================= */
function getRetroHouseRC(absPlanet, absPivot){

    let vedic = document.getElementById("vedicModeK")?.checked;

    /* ===============================
       KP MODE ‚Üí OLD LOGIC (UNCHANGED)
       =============================== */
    if(!vedic){

        let diff = absPivot - absPlanet;
        if(diff < 0) diff += 360;

        let h = Math.floor(diff / 30) + 1;
        if(h > 12) h -= 12;

        return h;
    }

    /* ===============================
       VEDIC MODE ‚Üí CENTERED LOGIC
       =============================== */

    /* signed angular distance */
    let delta = absPlanet - absPivot;

    /* normalize to -180 ... +180 */
    if(delta > 180) delta -= 360;
    if(delta < -180) delta += 360;

    /* ¬±15¬∞ ‚Üí FIRST HOUSE */
    if(delta >= -15 && delta <= 15){
        return 1;
    }

    /* backward counting AFTER first house */
    let back;

    if(delta > 15){
        back = delta - 15;
    }else{
        back = delta + 15;
    }

    let h = Math.floor(Math.abs(back) / 30) + 2;
    if(h > 12) h -= 12;

    return h;
}


/* =========================================================
   PIVOT ORDER (SAME AS OTHER TABLES)
   ========================================================= */
function getPivotOrderedPlanetsRC(){

    let pivot = document.getElementById("kPivot")?.value || "Lagna";
    let list = [...planets];

    if(pivot === "Lagna") return list;

    let idx = list.indexOf(pivot);
    if(idx === -1) return list;

    return list.slice(idx).concat(list.slice(0, idx));
}

/* =========================================================
   BUILD RETRO COUNTER TABLE
   ========================================================= */
function buildRetroCounterTable(){

    document.getElementById("retroCounterWrap")?.remove();

    let pivot = document.getElementById("kPivot")?.value || "Lagna";
    let pivotAbs = getAbsEntityRC(pivot);

    let wrap = document.createElement("div");
    wrap.id = "retroCounterWrap";

    let box = document.createElement("div");
    box.id = "retroCounter";

    box.innerHTML = `
        <h3>Retro Counter Table</h3>
        <table>
            <tr>
                <th>Planet</th>
                <th>Counter</th>
            </tr>
        </table>
    `;

    let table = box.querySelector("table");

    let ordered = getPivotOrderedPlanetsRC();

    ordered.forEach(p=>{

        /* üîí HARD RULE: Pivot is ALWAYS 1 */
        let counter;

        if(p === pivot){
            counter = 1;
        }else{
            let pAbs = getPlanetAbsDeg(p);
            counter = getRetroHouseRC(pAbs, pivotAbs);
        }

        let row = document.createElement("tr");
        row.innerHTML = `
            <td><b>${markPlanet(p)}</b></td>
            <td>${counter}</td>
        `;
        table.appendChild(row);
    });

    wrap.appendChild(box);
    document.getElementById("kundaliZone")?.appendChild(wrap);
}

/* =========================================================
   AUTO REFRESH (SAFE)
   ========================================================= */
(function(){
    const _draw = drawD1;
    drawD1 = function(){
        _draw();
        buildRetroCounterTable();
    };
})();

/* react to all relevant controls */
["kPivot","kpModeK","vedicModeK","retroModeK"].forEach(id=>{
    document.getElementById(id)
        ?.addEventListener("change", buildRetroCounterTable);
});

/* initial draw */
setTimeout(buildRetroCounterTable,0);
</script>





































<!-- =========================================================
     TABLE 1
     ========================================================= -->










<script>
/* =========================================================
   PART 1 : INPUT SYSTEM ONLY (NO KP LOGIC)
   DBA PLANET NAMES + DBA ORDER
   ========================================================= */

/* ---------- ZODIAC SIGNS ---------- */
const signs = [
    "", "Aries","Taurus","Gemini","Cancer","Leo","Virgo",
    "Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"
];

/* ---------- PLANETS (DBA ORDER) ---------- */
const planets = [
    "Surya",
    "Chandra",
    "Mangala",
    "Rahu",
    "Jupiter",
    "Saturn",
    "Budha",
    "Ketu",
    "Venus"
];

const table = document.getElementById("inputTable");

/* =========================================================
   INPUT PATCH (DARK MODE + VALIDATION)
   ========================================================= */

function attachInputLogic(inp, max){
    inp.type = "text";
    inp.maxLength = 2;
    inp.placeholder = "";
    inp.style.width = "42px";
    inp.style.textAlign = "center";

    /* DARK MODE STYLE */
    inp.style.background = "#020617";
    inp.style.color = "#f5e9c6";
    inp.style.border = "1px solid #ca8a04";
    inp.style.borderRadius = "6px";

    let warn = document.createElement("span");
    warn.textContent = "!";
    warn.style.color = "#ef4444";
    warn.style.marginLeft = "6px";
    warn.style.fontWeight = "700";
    warn.style.display = "none";
    inp.after(warn);

    inp.addEventListener("input", ()=>{
        inp.value = inp.value.replace(/\D/g,"");
        let v = Number(inp.value);

        if(inp.value !== "" && v > max){
            inp.style.background = "#7f1d1d";   /* red background */
            inp.style.color = "#ffffff";
            inp.style.border = "1px solid #ef4444";
            warn.style.display = "inline";
        }else{
            inp.style.background = "#020617";  /* back to dark */
            inp.style.color = "#f5e9c6";
            inp.style.border = "1px solid #ca8a04";
            warn.style.display = "none";
        }

        if(inp.value.length === 2){
            let all = [...document.querySelectorAll(
                'input[id$="_deg"],input[id$="_min"],input[id$="_sec"]'
            )];
            let idx = all.indexOf(inp);
            if(all[idx+1]) all[idx+1].focus();
        }
    });
}

/* ---------- DEGREE INPUT ---------- */
function createDegreeSelect(){
    let i = document.createElement("input");
    attachInputLogic(i, 29);
    return i;
}

/* ---------- MINUTE INPUT ---------- */
function createMinuteSelect(){
    let i = document.createElement("input");
    attachInputLogic(i, 59);
    return i;
}

/* ---------- SECOND INPUT ---------- */
function createSecondSelect(){
    let i = document.createElement("input");
    attachInputLogic(i, 59);
    return i;
}

/* ---------- BUILD 12 CUSPS ---------- */
for(let i=1;i<=12;i++){
    let row=table.insertRow();
    row.id="cuspRow"+i;

    row.insertCell().innerText="Cusp "+i;

    let signCell=row.insertCell();
    let signSel=document.createElement("select");
    signSel.id="c"+i+"_sign";
    signs.forEach(s=>{
        let o=document.createElement("option");
        o.value=s; o.text=s;
        signSel.appendChild(o);
    });
    signCell.appendChild(signSel);

    let degCell=row.insertCell();
    let degSel=createDegreeSelect();
    degSel.id="c"+i+"_deg";
    degCell.appendChild(degSel);

    let minCell=row.insertCell();
    let minSel=createMinuteSelect();
    minSel.id="c"+i+"_min";
    minCell.appendChild(minSel);

    let secCell=row.insertCell();
    let secSel=createSecondSelect();
    secSel.id="c"+i+"_sec";
    secCell.appendChild(secSel);
}

/* ---------- BUILD PLANETS (DBA ORDER) ---------- */
planets.forEach(p=>{
    let row=table.insertRow();
    row.insertCell().innerText=p;

    let signCell=row.insertCell();
    let signSel=document.createElement("select");
    signSel.id=p+"_sign";
    signs.forEach(s=>{
        let o=document.createElement("option");
        o.value=s; o.text=s;
        signSel.appendChild(o);
    });
    signCell.appendChild(signSel);

    let degCell=row.insertCell();
    let degSel=createDegreeSelect();
    degSel.id=p+"_deg";
    degCell.appendChild(degSel);

    let minCell=row.insertCell();
    let minSel=createMinuteSelect();
    minSel.id=p+"_min";
    minCell.appendChild(minSel);

    let secCell=row.insertCell();
    let secSel=createSecondSelect();
    secSel.id=p+"_sec";
    secCell.appendChild(secSel);
});

/* ---------- AUTO FILL SIGNS FROM LAGNA ---------- */
function autoFillSigns(){
    let lagnaIndex=document.getElementById("c1_sign").selectedIndex;
    if(lagnaIndex===0) return;
    for(let i=2;i<=12;i++){
        let idx=(lagnaIndex+(i-1))%12;
        if(idx===0) idx=12;
        document.getElementById("c"+i+"_sign").selectedIndex=idx;
    }
}

/* ---------- MANUAL / EQUAL CUSP TOGGLE ---------- */
manualMode.onchange=()=>{
    for(let i=2;i<=12;i++){
        document.getElementById("cuspRow"+i)
            .classList.toggle("hidden",!manualMode.checked);
    }
};
manualMode.onchange();






/* =========================================================
   SAVE JSON (UPDATED ‚Äì WITH VIMSHOTTARI EVENTS)
   ========================================================= */
function saveJSON(){

    let personName =
        document.getElementById("personName")?.value.trim() || "UNKNOWN";

    let data={
        personName: personName,
        manualMode: manualMode.checked,

        /* üî• DOB / TOB SAVE */
        baseDate: document.getElementById("baseDate").value || "",
        baseTime: document.getElementById("baseTimeLock").value || "",

        cusps:{},
        planets:{}
    };

    /* ---------- SAVE CUSPS ---------- */
    for(let i=1;i<=12;i++){
        data.cusps[i]={
            sign:document.getElementById("c"+i+"_sign").value,
            deg: document.getElementById("c"+i+"_deg").value,
            min: document.getElementById("c"+i+"_min").value,
            sec: document.getElementById("c"+i+"_sec").value
        };
    }

    /* ---------- SAVE PLANETS ---------- */
    planets.forEach(p=>{
        data.planets[p]={
            sign:document.getElementById(p+"_sign").value,
            deg: document.getElementById(p+"_deg").value,
            min: document.getElementById(p+"_min").value,
            sec: document.getElementById(p+"_sec").value
        };
    });

    /* ---------- SAVE VIMSHOTTARI EVENTS (ONLY 5) ---------- */
    data.vimshottariEvents = [];

    for(let i=1;i<=5;i++){
        data.vimshottariEvents.push({
            name: document.getElementById(`en${i}`)?.value || "",
            date: document.getElementById(`ed${i}`)?.value || ""
        });
    }

    /* ---------- DOWNLOAD ---------- */
    let blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=personName + ".json";
    a.click();
}









/* =========================================================
   LOAD JSON (UPDATED ‚Äì WITH VIMSHOTTARI EVENTS)
   ========================================================= */
function loadJSON(){

    let f=document.createElement("input");
    f.type="file";
    f.accept="application/json";

    f.onchange=e=>{
        let r=new FileReader();
        r.onload=()=>{

            let d=JSON.parse(r.result);

            /* ---------- NAME ---------- */
            if(d.personName && document.getElementById("personName")){
                document.getElementById("personName").value=d.personName;
            }

            /* ---------- DOB / TOB ---------- */
            if(d.baseDate){
                document.getElementById("baseDate").value=d.baseDate;
            }
            if(d.baseTime){
                document.getElementById("baseTimeLock").value=d.baseTime;
            }

            /* ---------- MODE ---------- */
            manualMode.checked=d.manualMode;
            manualMode.onchange();

            /* ---------- RESTORE CUSPS ---------- */
            for(let i=1;i<=12;i++){
                document.getElementById("c"+i+"_sign").value=d.cusps[i].sign;
                document.getElementById("c"+i+"_deg").value=d.cusps[i].deg;
                document.getElementById("c"+i+"_min").value=d.cusps[i].min;
                document.getElementById("c"+i+"_sec").value=d.cusps[i].sec;
            }

            /* ---------- RESTORE PLANETS ---------- */
            planets.forEach(p=>{
                document.getElementById(p+"_sign").value=d.planets[p].sign;
                document.getElementById(p+"_deg").value=d.planets[p].deg;
                document.getElementById(p+"_min").value=d.planets[p].min;
                document.getElementById(p+"_sec").value=d.planets[p].sec;
            });

            /* ---------- RESTORE VIMSHOTTARI EVENTS (ONLY 5) ---------- */
            if(d.vimshottariEvents){
                d.vimshottariEvents.forEach((ev,i)=>{
                    let idx=i+1;
                    if(document.getElementById(`en${idx}`)){
                        document.getElementById(`en${idx}`).value=ev.name||"";
                    }
                    if(document.getElementById(`ed${idx}`)){
                        document.getElementById(`ed${idx}`).value=ev.date||"";
                    }
                });
            }
        };
        r.readAsText(e.target.files[0]);
    };
    f.click();
}












/* =========================================================
   CLEAR ALL (UNCHANGED)
   ========================================================= */



function clearAll(){

    /* RESET BASE TIME STATE */
    BASE_EPOCH = null;

    /* ENABLE + CLEAR DATE & TIME */
    document.getElementById("baseDate").disabled = false;
    document.getElementById("baseTimeLock").disabled = false;
    document.getElementById("baseDate").value = "";
    document.getElementById("baseTimeLock").value = "";

    /* RESET MODES */
    manualMode.checked = true;
    manualMode.onchange();

    /* CLEAR NAME */
    document.getElementById("personName").value = "";

    /* CLEAR CUSPS */
    for(let i=1;i<=12;i++){
        document.getElementById("c"+i+"_sign").selectedIndex = 0;
        document.getElementById("c"+i+"_deg").value = "";
        document.getElementById("c"+i+"_min").value = "";
        document.getElementById("c"+i+"_sec").value = "";
    }

    /* CLEAR PLANETS */
    planets.forEach(p=>{
        document.getElementById(p+"_sign").selectedIndex = 0;
        document.getElementById(p+"_deg").value = "";
        document.getElementById(p+"_min").value = "";
        document.getElementById(p+"_sec").value = "";
    });

    /* CLEAR OUTPUT */
    document.getElementById("output").innerHTML = "";
}







/* ---------- FILL ALL SECONDS = 0 ---------- */
function fillAllSeconds(){
    document.querySelectorAll('input[id$="_sec"]').forEach(i=>{
        if(i.value==="") i.value="0";
    });
}
</script>


















<script>
/* =========================================================
   KP CONSTANTS (DBA NAMES)
   ========================================================= */

const signLords = {
    Aries:"Mangala", Taurus:"Venus", Gemini:"Budha",
    Cancer:"Chandra", Leo:"Surya", Virgo:"Budha",
    Libra:"Venus", Scorpio:"Mangala",
    Sagittarius:"Jupiter", Capricorn:"Saturn",
    Aquarius:"Saturn", Pisces:"Jupiter"
};

const starCycle = [
    "Ketu","Venus","Surya","Chandra",
    "Mangala","Rahu","Jupiter","Saturn","Budha"
];

const vimYears = {
    Ketu:7, Venus:20, Surya:6, Chandra:10,
    Mangala:7, Rahu:18, Jupiter:16, Saturn:19, Budha:17
};

let cuspsData = [];

</script>

<script>
/* =========================================================
   TENANTED / UNTENANTED ENGINE (GLOBAL)
   ========================================================= */

/* cache */
let TENANTED_CACHE = null;

/* build tenanted set */
function computeTenantedPlanets(){
    let set = new Set();

    // üîí ONLY 9 PLANETS ‚Äî NOT CUSPS
    planets.forEach(p=>{
        let kp = getPlanetKPLords(p);
        if(kp && kp.star){
            set.add(kp.star);
        }
    });

    return set;
}
	
/* public helper */






function markPlanet(p){
    if(!p) return "";

    p = String(p).trim();   // üîí HARD NORMALIZATION

    if(p === "Lagna") return p;

   /* cache is built explicitly in buildCuspalChart */

    return TENANTED_CACHE.has(p)
        ? p
        : p + " $";
}








/* reset cache whenever cusps rebuild */
(function(){
    const _orig = buildCuspalChart;
    buildCuspalChart = function(){
        TENANTED_CACHE = null;
        _orig();
    };
})();
</script>

<script>

/* =========================================================
   DEGREE UTILITIES
   ========================================================= */
function absoluteDeg(signIndex, deg, min, sec){
    return (signIndex - 1) * 30
         + Number(deg)
         + Number(min)/60
         + Number(sec)/3600;
}

function getStarIndex(absDeg){
    return Math.floor(absDeg / 13.3333333333) % 9;
}

function getSubIndex(starIndex, degInsideStar){
    let start = 0;
    for(let i=0;i<9;i++){
        let lord = starCycle[(starIndex+i)%9];
        let span = (vimYears[lord]/120)*13.3333333333;
        if(degInsideStar >= start && degInsideStar < start+span){
            return (starIndex+i)%9;
        }
        start += span;
    }
    return starIndex;
}

function getSSLIndex(subIndex, d){
    let start = 0;
    for(let i=0;i<9;i++){
        let lord = starCycle[(subIndex+i)%9];
        let span = (vimYears[lord]/120)*d.totalSpan;
        if(d.offset >= start && d.offset < start+span){
            return (subIndex+i)%9;
        }
        start += span;
    }
    return subIndex;
}

/* =========================================================
   BUILD KP CUSPS (ONLY PLACE IT EXISTS)
   ========================================================= */
function buildCuspalChart(){

    if(!lockBaseDateTime()) return;

    cuspsData = [];

    let manual = manualMode.checked;

    let lagnaSign = document.getElementById("c1_sign").selectedIndex;
    let lagnaDeg  = document.getElementById("c1_deg").value;
    let lagnaMin  = document.getElementById("c1_min").value;
    let lagnaSec  = document.getElementById("c1_sec").value;

    for(let i=1;i<=12;i++){

        let signIndex, deg, min, sec;

        if(manual){
            signIndex = document.getElementById("c"+i+"_sign").selectedIndex;
            deg = document.getElementById("c"+i+"_deg").value;
            min = document.getElementById("c"+i+"_min").value;
            sec = document.getElementById("c"+i+"_sec").value;
        }else{
            signIndex = (lagnaSign + (i-1)) % 12;
            if(signIndex === 0) signIndex = 12;
            deg = lagnaDeg;  min = lagnaMin;  sec = lagnaSec;


        }

        let abs = absoluteDeg(signIndex,deg,min,sec);
        let star = getStarIndex(abs);
        let inside = abs % 13.3333333333;
        let sub = getSubIndex(star,inside);

        let span = (vimYears[starCycle[sub]]/120)*13.3333333333;
        let start = 0;
        for(let k=0;k<9;k++){
            let lord = starCycle[(star+k)%9];
            if((star+k)%9===sub) break;
            start += (vimYears[lord]/120)*13.3333333333;
        }

        let ssl = getSSLIndex(sub,{
            offset:inside-start,
            totalSpan:span
        });

        cuspsData.push({
            bhava:i,
            sign:signs[signIndex],
            deg,min,sec,
            absDeg:abs,
            signLord:signLords[signs[signIndex]],
            starLord:starCycle[star],
            subLord:starCycle[sub],
            sslLord:starCycle[ssl]
        });
    }

    cuspsData.sort((a,b)=>a.absDeg-b.absDeg);

/* üîí BUILD TENANTED CACHE ONCE ‚Äì FINAL */
TENANTED_CACHE = computeTenantedPlanets();

renderCuspalTable();

}
</script>

















<script>
/* =========================================================
   RENDER KP TABLE-2 (BHAVA ORDER ONLY)
   ========================================================= */
function renderCuspalTable(){

    /* TEMP BHAVA SORT ‚Äî DISPLAY ONLY */
    let view = [...cuspsData].sort((a,b)=>a.bhava-b.bhava);

    let html = `
    <h2>Table-2 Cuspal Interlink Chart</h2>
    <table>
        <tr>
            <th>Bhava</th>
            <th>Sign</th>
            <th>Degree</th>
            <th>Sign Lord</th>
            <th>Star Lord</th>
            <th>Sub Lord</th>
            <th>Sub-Sub Lord</th>
        </tr>`;

    view.forEach(c=>{
        html += `
        <tr>
            <td>${c.bhava}</td>
            <td>${c.sign}</td>
            <td>${String(c.deg).padStart(2,"0")}¬∞
                ${String(c.min).padStart(2,"0")}'
                ${String(c.sec).padStart(2,"0")}"</td>
            <td>${c.signLord}</td>
			<td>${c.starLord}</td>
			<td>${markPlanet(c.subLord)}</td>
			<td>${markPlanet(c.sslLord)}</td>

        </tr>`;
    });

    html += `</table>`;
    document.getElementById("output").innerHTML = html;
}
</script>



















<!-- =========================================================
     PART 3 : PLANET HOUSE ENGINE + PIVOT SYSTEM (DBA + CSL)
     (RETRO SUPPORT ‚Äì PLACEMENT ONLY)
     ========================================================= -->
<script>


let USE_TRUE_NODE_KP = false; // default = MEAN NODE


/* üî• SYNC TRUE NODE STATE ON LOAD */
document.addEventListener("DOMContentLoaded", () => {
    const chk = document.getElementById("trueNodeModeKP");
    if(chk){
        USE_TRUE_NODE_KP = chk.checked;
    }
});



/* =========================================================
   UI : PIVOT + HOUSE MODE
   ========================================================= */
document.body.insertAdjacentHTML("beforeend", `
<h2>Pivot & House Mode</h2>



<select id="pivotSelect">
    <option value="Lagna">Lagna</option>

    <option value="Surya">Surya</option>
    <option value="Chandra">Chandra</option>
    <option value="Mangala">Mangala</option>
    <option value="Rahu">Rahu</option>
    <option value="Jupiter">Jupiter</option>
    <option value="Saturn">Saturn</option>
    <option value="Budha">Budha</option>
    <option value="Ketu">Ketu</option>
    <option value="Venus">Venus</option>

    <option value="CSL2">2 CSL</option>
    <option value="CSL3">3 CSL</option>
    <option value="CSL4">4 CSL</option>
    <option value="CSL5">5 CSL</option>
    <option value="CSL6">6 CSL</option>
    <option value="CSL7">7 CSL</option>
    <option value="CSL8">8 CSL</option>
    <option value="CSL9">9 CSL</option>
    <option value="CSL10">10 CSL</option>
    <option value="CSL11">11 CSL</option>
    <option value="CSL12">12 CSL</option>
</select>

<label style="margin-left:15px;">
    <input type="checkbox" id="vedicMode" checked>
    Vedic House (¬±15¬∞)
</label>

<label style="margin-left:15px;">
    <input type="checkbox" id="retroMode">
    Retro
</label>




<label style="margin-left:15px;">
    <input type="checkbox" id="trueNodeModeKP" checked>
    True Node
</label>




<select id="taraSelect" style="margin-left:15px;">
    <option value="PIVOT_STAR" selected>Pivots Starlord</option>

    <option value="Surya">Surya</option>
    <option value="Chandra">Chandra</option>
    <option value="Mangala">Mangala</option>
    <option value="Rahu">Rahu</option>
    <option value="Jupiter">Jupiter</option>
    <option value="Saturn">Saturn</option>
    <option value="Budha">Budha</option>
    <option value="Ketu">Ketu</option>
    <option value="Venus">Venus</option>

    <option value="CSL1">1 CSL Starlord</option>
    <option value="CSL2">2 CSL Starlord</option>
    <option value="CSL3">3 CSL Starlord</option>
    <option value="CSL4">4 CSL Starlord</option>
    <option value="CSL5">5 CSL Starlord</option>
    <option value="CSL6">6 CSL Starlord</option>
    <option value="CSL7">7 CSL Starlord</option>
    <option value="CSL8">8 CSL Starlord</option>
    <option value="CSL9">9 CSL Starlord</option>
    <option value="CSL10">10 CSL Starlord</option>
    <option value="CSL11">11 CSL Starlord</option>
    <option value="CSL12">12 CSL Starlord</option>
</select>




`);

/* =========================================================
   ROTATE HOUSE FROM PIVOT (UNCHANGED)
   ========================================================= */
function rotateHouse(h, pivot){
    let x = h - pivot + 1;
    if(x <= 0) x += 12;
    return x;
}

/* =========================================================
   RETRO PLACEMENT INVERSION (DISPLAY ONLY)
   RULE:
   1‚Üí1, 7‚Üí7, others: 14-h
   ========================================================= */
function applyRetroPlacement(h){
    if(h === 1 || h === 7) return h;
    return 14 - h;
}

/* =========================================================
   GET PLANET ABSOLUTE DEGREE
   ========================================================= */
function getPlanetAbsDeg(p){
    return absoluteDeg(
        signs.indexOf(document.getElementById(p+"_sign").value),
        document.getElementById(p+"_deg").value,
        document.getElementById(p+"_min").value,
        document.getElementById(p+"_sec").value
    );
}

/* =========================================================
   KP HOUSE CALCULATION
   ========================================================= */
function getPlanetHouseKP(p){

    let pAbs = getPlanetAbsDeg(p);

    for(let i=0;i<cuspsData.length;i++){

        let cur  = cuspsData[i];
        let next = cuspsData[(i+1) % cuspsData.length];

        let start = cur.absDeg;
        let end   = next.absDeg;

        if(start < end){
            if(pAbs >= start && pAbs < end){
                return cur.bhava;
            }
        }else{
            if(pAbs >= start || pAbs < end){
                return cur.bhava;
            }
        }
    }
    return cuspsData[0].bhava;
}

/* =========================================================
   VEDIC HOUSE (¬±15¬∞)
   ========================================================= */
function getPlanetHouseVedic(p){

    let pAbs = getPlanetAbsDeg(p);

    for(let c of cuspsData){

        let start = c.absDeg - 15;
        let end   = c.absDeg + 15;

        if(start < 0)   start += 360;
        if(end >= 360)  end   -= 360;

        if(start < end){
            if(pAbs >= start && pAbs < end) return c.bhava;
        }else{
            if(pAbs >= start || pAbs < end) return c.bhava;
        }
    }
    return cuspsData[0].bhava;
}

/* =========================================================
   HOUSE SELECTOR (UNCHANGED)
   ========================================================= */
function getPlanetHouse(p){
    return document.getElementById("vedicMode").checked
        ? getPlanetHouseVedic(p)
        : getPlanetHouseKP(p);
}

/* =========================================================
   GET PIVOT HOUSE (UNCHANGED)
   ========================================================= */
function getPivotHouse(){

    let pivot = document.getElementById("pivotSelect").value;

    if(pivot === "Lagna") return 1;

    if(pivot.startsWith("CSL")){
        return Number(pivot.replace("CSL",""));
    }

    return getPlanetHouse(pivot);
}

/* =========================================================
   AUTO REFRESH HOOKS
   ========================================================= */
const __buildCuspalChart = buildCuspalChart;
buildCuspalChart = function(){
    __buildCuspalChart();

    /* existing chain */
    if(typeof buildTable3 === "function"){
        buildTable3();
    }

    /* üî• ADD THIS LINE */
    if(typeof buildPivotCuspalTable === "function"){
        buildPivotCuspalTable();
    }
};

["pivotSelect","vedicMode","retroMode"].forEach(id=>{
    document.getElementById(id).onchange = ()=>{
        if(typeof buildTable3 === "function"){
            buildTable3();
        }
    };
});
</script>



<script>
/* =========================================================
   AUTO REFRESH ‚Äì NEW PIVOT CUSP TABLE ONLY
   ========================================================= */
document.getElementById("pivotSelect")?.addEventListener("change", ()=>{
    buildPivotCuspalTable();
});

document.getElementById("vedicMode")?.addEventListener("change", ()=>{
    buildPivotCuspalTable();
});

document.getElementById("retroMode")?.addEventListener("change", ()=>{
    buildPivotCuspalTable();
});
</script>






<script>
/* =========================================================
   INITIAL DRAW FIX ‚Äì SHOW TABLE-X FOR DEFAULT LAGNA
   ========================================================= */
document.addEventListener("DOMContentLoaded", ()=>{
    if(typeof buildPivotCuspalTable === "function"){
        buildPivotCuspalTable();
    }
});
</script>





















<!-- =========================================================
     TABLE 4
     ========================================================= -->








<!-- =========================================================
     PART 4 : KP PLANETARY TABLE-4 (PIVOT-ORDERED)
     (RAHU / KETU SIGN-LORD DISPOSITOR PATCH ‚Äì FINAL)
     ========================================================= -->
<script>
function buildTable3(){

    if(cuspsData.length === 0) return;

    let old = document.getElementById("table3");
    if(old) old.remove();

    /* ---------- PIVOT SELECTION ---------- */
    let pivot = document.getElementById("pivotSelect").value;

    /* ---------- PLANET DISPLAY ORDER ---------- */
    let displayPlanets = [...planets];

    if(pivot !== "Lagna"){
        let idx = displayPlanets.indexOf(pivot);
        if(idx !== -1){
            displayPlanets =
                displayPlanets.slice(idx)
                .concat(displayPlanets.slice(0, idx));
        }
    }

    let pivotHouse = getPivotHouse();

    let html = `
    <div id="table3">
    <h2>Table-4 : Planetary House Significations (Pivot Based)</h2>
    <table>
        <tr>
            <th>Planet</th>
            <th>Sub Lord</th>
            <th>Sub-Sub Lord</th>
            <th>Star Lord</th>
            <th>Sign Lord</th>
            <th>Placement</th>
        </tr>
    `;

    /* ---------- BUILD ROWS ---------- */
    displayPlanets.forEach(p=>{

        let sub=[], ssl=[], star=[], sign=[];

        cuspsData.forEach(c=>{

            let h = rotateHouse(c.bhava, pivotHouse);

            if(c.subLord  === p) sub.push(h);
            if(c.sslLord  === p) ssl.push(h);
            if(c.starLord === p) star.push(h);
            if(c.signLord === p) sign.push(h);
        });

        /* ---------- RAHU / KETU SIGN-LORD DISPOSITOR (ALWAYS RECALC) ---------- */
			if(p === "Rahu" || p === "Ketu"){

            let signPlaced =
                document.getElementById(p+"_sign").value;

            let dispositor = signLords[signPlaced];

            if(dispositor){

                /* take ONLY sign-lord houses of dispositor */
                cuspsData.forEach(c=>{
                    if(c.signLord === dispositor){
                        let h = rotateHouse(c.bhava, pivotHouse);
                        sign.push(h);
                    }
                });

               /* also add dispositor's own placement (RETRO AWARE) */
			let dispPlacement =
				rotateHouse(
					getPlanetHouse(dispositor),
					pivotHouse
				);

				if(document.getElementById("retroMode")?.checked){
					dispPlacement = applyRetroPlacement(dispPlacement);
				}

				/* remove any old placement first */
				sign = sign.filter(h => h !== dispPlacement);

				sign.push(dispPlacement);


            }
        }

        /* ---------- SORT & UNIQUE ---------- */
        sub  = [...new Set(sub.map(Number))].sort((a,b)=>a-b);
        ssl  = [...new Set(ssl.map(Number))].sort((a,b)=>a-b);
        star = [...new Set(star.map(Number))].sort((a,b)=>a-b);
        sign = [...new Set(sign.map(Number))].sort((a,b)=>a-b);

        /* ---------- PLACEMENT (UNCHANGED) ---------- */
        let placed =
            rotateHouse(getPlanetHouse(p), pivotHouse);

        if(document.getElementById("retroMode")?.checked){
            placed = applyRetroPlacement(placed);
        }

        html += `
	<tr>
    <td><b>${markPlanet(p)}</b></td>

    <td>${sub.length  ? sub.join(",")  : ""}</td>
    <td>${ssl.length  ? ssl.join(",")  : ""}</td>
    <td>${star.length ? star.join(",") : ""}</td>
    <td>${sign.length ? sign.join(",") : ""}</td>
    <td>${placed}</td>
	</tr>
	`;

    });

    html += `
    </table>
    </div>
    `;

    const anchor = document.getElementById("kp-fixed-bottom");
const wrapper = document.createElement("div");
wrapper.innerHTML = html;
anchor.before(wrapper);

}
</script>
































<!-- =========================================================
     TABLE 3
     ========================================================= -->








<script>
/* =========================================================
   TABLE-3 : PIVOT BASED CUSPAL INTERLINK (DYNAMIC)
   (SAFE ‚Äì NEW TABLE ONLY)
   ========================================================= */
function buildPivotCuspalTable(){

    if(!cuspsData || cuspsData.length === 0) return;

    /* ---------- BASE BHAVA ORDER ---------- */
    let base = [...cuspsData].sort((a,b)=>a.bhava-b.bhava);

    /* ---------- GET PIVOT HOUSE ---------- */
    let pivotHouse = getPivotHouse();   // already exists in your system

    /* ---------- ROTATE DATA ---------- */
    let rotated = [];
    let start = base.findIndex(c=>c.bhava===pivotHouse);
    if(start < 0) start = 0;

    for(let i=0;i<12;i++){
        rotated.push(base[(start+i)%12]);
    }

    /* ---------- BUILD TABLE ---------- */
    let html = `
    <h2>Table-3 : Pivot Based Cuspal Interlink (Dynamic)</h2>
    <table>
        <tr>
            <th>Bhava</th>
            <th>Sign</th>
            <th>Degree</th>
            <th>Sign Lord</th>
            <th>Star Lord</th>
            <th>Sub Lord</th>
            <th>Sub-Sub Lord</th>
        </tr>
    `;

    rotated.forEach((c,i)=>{
        html += `
        <tr>
            <td>${i+1}</td>
            <td>${c.sign}</td>
            <td>
                ${String(c.deg).padStart(2,"0")}¬∞
                ${String(c.min).padStart(2,"0")}'
                ${String(c.sec).padStart(2,"0")}"
            </td>
            <td>${c.signLord}</td>
            <td>${c.starLord}</td>
			<td>${markPlanet(c.subLord)}</td>
			<td>${markPlanet(c.sslLord)}</td>

        </tr>
        `;
    });

    html += `</table>`;

    document.getElementById("pivotCuspalTable").innerHTML = html;
}
</script>



<div id="pivotCuspalTable"></div>













<!-- =========================================================
     SYNTHETIC TIME SHIFT + DATE‚ÄìTIME CONTROL (SINGLE BOX)
     ========================================================= -->

<style>
.kpShiftBox{
  margin:30px 0;
  padding:18px;
  border:2px solid #a86b17;
  background:#120606;
  box-shadow:0 0 18px rgba(255,159,28,.45);
}
.kpShiftTitle{
  text-align:center;
  color:#ff9f1c;
  font-weight:900;
  letter-spacing:1.6px;
  margin-bottom:14px;
}
.kpShiftGrid{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:28px;
  flex-wrap:wrap;
}
.kpLeft,.kpRight{
  display:flex;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}
.kpShiftBox input,
.kpShiftBox select{
  background:#020617;
  color:#f5e9c6;
  border:1px solid #ca8a04;
  padding:6px 8px;
  border-radius:6px;
  font-weight:700;
}
.kpShiftBox input[type="date"]::-webkit-calendar-picker-indicator,
.kpShiftBox input[type="time"]::-webkit-calendar-picker-indicator{
  filter:invert(1);
}
.kpShiftBox button{
  background:linear-gradient(135deg,#ff9f1c,#b11226);
  border:none;
  color:#1a0606;
  padding:7px 16px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 0 12px rgba(255,159,28,.4);
}
.kpShiftBox button:hover{
  background:linear-gradient(135deg,#ffb347,#d4142a);
}
#shiftCounter{
  color:#facc15;
  font-weight:900;
  letter-spacing:.8px;
  white-space:nowrap;
}
</style>

<script>
let SHIFT_SECONDS = 0;
let BASE_MASTER_DATETIME = null;

/* ============================
   MEAN MOTION (deg/sec)
   ============================ */
const RATE_SEC = {
  Lagna:15/3600, Surya:0.9856/86400, Chandra:13.176/86400,
  Mangala:0.524/86400, Budha:1.2/86400, Venus:1.2/86400,
  Jupiter:0.083/86400, Saturn:0.033/86400,
  Rahu:-0.053/86400, Ketu:-0.053/86400
};

function absFromInput(s,d,m,ss){
  let si=document.getElementById(s).selectedIndex;
  if(si<=0)return null;
  return (si-1)*30+
    (+document.getElementById(d).value||0)+
    (+document.getElementById(m).value||0)/60+
    (+document.getElementById(ss).value||0)/3600;
}

function writeAbs(abs,s,d,m,ss){
  abs=((abs%360)+360)%360;
  let si=Math.floor(abs/30)+1;
  let inside=abs%30;
  let dd=Math.floor(inside);
  let mf=(inside-dd)*60;
  let mm=Math.floor(mf);
  let sec=Math.round((mf-mm)*60);
  if(sec===60){sec=0;mm++;}
  if(mm===60){mm=0;dd++;}
  if(dd===30){dd=0;si++;}
  if(si>12)si=1;
  document.getElementById(s).selectedIndex=si;
  document.getElementById(d).value=dd;
  document.getElementById(m).value=mm;
  document.getElementById(ss).value=sec;
}

function shiftEntity(n,s,d,m,ss,dt){
  let a=absFromInput(s,d,m,ss);
  if(a===null)return;
  writeAbs(a+RATE_SEC[n]*dt,s,d,m,ss);
}

function applyShift(dt){
  SHIFT_SECONDS+=dt;

  /* HARD LIMIT ¬±3000 MINUTES */
  let LIM=3000*60;
  if(SHIFT_SECONDS>LIM)SHIFT_SECONDS=LIM;
  if(SHIFT_SECONDS<-LIM)SHIFT_SECONDS=-LIM;

  for(let i=1;i<=12;i++){
    shiftEntity("Lagna",
      "c"+i+"_sign","c"+i+"_deg","c"+i+"_min","c"+i+"_sec",dt);
  }

  planets.forEach(p=>{
    shiftEntity(p,p+"_sign",p+"_deg",p+"_min",p+"_sec",dt);
  });

  buildCuspalChart();
  drawD1();
  updateShiftDisplay();
  syncDateTimeTool();
}

function shiftStep(dir){
  let j=+jumpVal.value||0;
  let dt=(jumpMode.value==="sec"?j:j*60)*dir;
  if(dt)applyShift(dt);
}

function updateShiftDisplay(){
  let a=Math.abs(SHIFT_SECONDS);
  let m=Math.floor(a/60);
  let s=a%60;
  let sg=SHIFT_SECONDS>0?"+":SHIFT_SECONDS<0?"‚àí":"";
  shiftCounter.textContent=
    `Current Shift : ${sg}${m} min ${s} sec`;
}

/* ============================
   DATE‚ÄìTIME TOOL (TIME PRIMARY)
   ============================ */
function captureBaseDateTime(){
  if(baseDate.value && baseTimeLock.value){
    BASE_MASTER_DATETIME =
      new Date(baseDate.value+"T"+baseTimeLock.value);
    dateCtrl.value = baseDate.value;
    timeCtrl.value = baseTimeLock.value;
  }
}

function applyDateTimeChange(){
  if(!BASE_MASTER_DATETIME)return;
  let n=new Date(dateCtrl.value+"T"+timeCtrl.value);
  let diff=(n-BASE_MASTER_DATETIME)/1000;
  applyShift(diff-SHIFT_SECONDS);
}

function syncDateTimeTool(){
  if(!BASE_MASTER_DATETIME)return;
  let d=new Date(
    BASE_MASTER_DATETIME.getTime()+SHIFT_SECONDS*1000
  );
  dateCtrl.value=d.toISOString().slice(0,10);
  timeCtrl.value=d.toTimeString().slice(0,8);
}
</script>

<div class="kpShiftBox">
  <div class="kpShiftTitle">
    Synthetic Time Shift &nbsp; | &nbsp; Date‚ÄìTime Control
  </div>

  <div class="kpShiftGrid">

    <!-- LEFT : SYNTHETIC SHIFT -->
    <div class="kpLeft">
      Jump :
      <input id="jumpVal" type="number" value="30" style="width:70px">
      <select id="jumpMode">
        <option value="sec">Seconds</option>
        <option value="min">Minutes</option>
      </select>

      <button onclick="shiftStep(-1)">‚óÄ</button>
      <button onclick="shiftStep(1)">‚ñ∂</button>

      <div id="shiftCounter">
        Current Shift : 0 min 0 sec
      </div>
    </div>

    <!-- RIGHT : DATE‚ÄìTIME TOOL -->
    <div class="kpRight">
      üìÖ <input type="date" id="dateCtrl" onchange="applyDateTimeChange()">
      ‚è± <input type="time" id="timeCtrl" step="1"
               onchange="applyDateTimeChange()">
    </div>

  </div>
</div>

<script>
document.querySelector("button[onclick='buildCuspalChart()']")
 ?.addEventListener("click",()=>setTimeout(captureBaseDateTime,0));
</script>















<!-- =========================================================
     TABLE 5
     ========================================================= -->

















<!-- =========================================================
     PART 5 : KP TABLE-5 (PIVOT ORDER + SORT FIX FINAL)
     + TENANTED / UNTENANTED MARKING ($)
     ========================================================= -->
<script>
/* =========================================================
   HELPER : SORT HOUSE LIST STRING
   ========================================================= */
function sortHouseString(str){
    if(!str || str === "") return "";
    return str.split(",").map(Number).sort((a,b)=>a-b).join(",");
}

/* =========================================================
   REQUIRED : PLANET KP LORDS (UNCHANGED)
   ========================================================= */
function getPlanetKPLords(p){

    let signIndex = signs.indexOf(
        document.getElementById(p+"_sign").value
    );
    if(signIndex <= 0) return null;

    let deg = document.getElementById(p+"_deg").value;
    let min = document.getElementById(p+"_min").value;
    let sec = document.getElementById(p+"_sec").value;

    let absDeg = absoluteDeg(signIndex, deg, min, sec);

    let starIndex = getStarIndex(absDeg);
    let degInsideStar = absDeg % 13.3333333333;
    let subIndex = getSubIndex(starIndex, degInsideStar);

    let subSpan = (vimYears[starCycle[subIndex]] / 120) * 13.3333333333;
    let subStart = 0;
    for(let i=0;i<9;i++){
        let lord = starCycle[(starIndex + i) % 9];
        if((starIndex + i) % 9 === subIndex) break;
        subStart += (vimYears[lord] / 120) * 13.3333333333;
    }

    let sslIndex = getSSLIndex(subIndex,{
        offset: degInsideStar - subStart,
        totalSpan: subSpan
    });

    return {
        planet:p,
        star:starCycle[starIndex],
        sub:starCycle[subIndex],
        ssl:starCycle[sslIndex]
    };
}






/* üîí TARA MANUAL LOCK */
let TARA_MANUAL_LOCK = false;
let TARA_LAST_JANMA = null;



/* =========================================================
   TARA ENGINE (TABLE-5 ONLY)
   ========================================================= */

const TARA_SEQ = [
    "Janma","Sampath","Vipath","Kshema",
    "Pratyari","Sadhana","Nidana","Mithra","Ati-Mithra"
];









function resolveTaraJanmaPlanet(){

    const tSel = document.getElementById("taraSelect");
    if(!tSel) return null;

    const sel = tSel.value;
    let janma = null;

    /* ===============================
       MANUAL SOURCE
       =============================== */
    if(sel !== "PIVOT_STAR"){
        janma = resolveExplicitTaraSource(sel);
    }
    else{
        /* ===============================
           PIVOT SOURCE
           =============================== */
        const pivot = document.getElementById("pivotSelect")?.value;

        if(pivot === "Lagna"){
            const c1 = cuspsData.find(c => c.bhava === 1);
            janma = c1 ? c1.starLord : null;
        }
        else if(planets.includes(pivot)){
            janma = getPlanetKPLords(pivot)?.star || null;
        }
    }

    /* üîí cache last valid janma */
    if(janma) TARA_LAST_JANMA = janma;

    /* fallback safety */
    return janma || TARA_LAST_JANMA;
}







function resolveExplicitTaraSource(sel){

    /* DIRECT PLANET */
    if(planets.includes(sel)){
        return sel;
    }

    /* CSL ‚Üí STAR LORD */
    if(sel.startsWith("CSL")){
        const n = Number(sel.replace("CSL",""));
        const c = cuspsData.find(x => x.bhava === n);
        return c ? c.starLord : null;
    }

    return null;
}









/* =========================================================
   TARA ‚Üî PIVOT EVENT BINDING (FINAL)
   ========================================================= */

/* USER MANUAL TARA CHANGE ‚Üí LOCK */

/* USER MANUAL TARA CHANGE ‚Üí LOCK */
document.getElementById("taraSelect")
  ?.addEventListener("change", () => {

      TARA_MANUAL_LOCK = true;
      buildTable4();
	   
	   if(typeof buildTable6 === "function"){
        buildTable6();
      }

  });

/* PIVOT CHANGE ‚Üí FORCE RESET TARA */
document.getElementById("pivotSelect")
  ?.addEventListener("change", () => {

      const t = document.getElementById("taraSelect");

      /* üî• pivot always re-syncs Tara */
      TARA_MANUAL_LOCK = false;

      if(t){
          t.value = "PIVOT_STAR";
      }

      buildTable4();
	  if(typeof buildTable6 === "function"){
          buildTable6();
      }
  });










function computeTaraIndex(janma, target){

    if(!janma || !target) return "";

    const a = starCycle.indexOf(janma);
    const b = starCycle.indexOf(target);

    if(a < 0 || b < 0) return "";

    return TARA_SEQ[(b - a + 9) % 9];
}








/* =========================================================
   BUILD TABLE-5 (TENANTED / UNTENANTED APPLIED)
   ========================================================= */
function buildTable4(){

    document.getElementById("table4")?.remove();

    let t3Table = document.querySelector("#table3 table");
    if(!t3Table) return;

    window.__T3_CACHE__ = {};
    let t3 = window.__T3_CACHE__;

    t3Table.querySelectorAll("tr").forEach((r,i)=>{
        if(i===0) return;
        let c=r.children;
        let key = c[0].innerText
			.replace(/\$/g,"")
			.trim()
			.split(/\s+/)[0];   // üî• TAKE ONLY FIRST TOKEN

		t3[key] = {

            sub:sortHouseString(c[1].innerText),
            ssl:sortHouseString(c[2].innerText),
            star:sortHouseString(c[3].innerText),
            sign:sortHouseString(c[4].innerText),
            place:c[5].innerText
        };
    });

    let pivot=document.getElementById("pivotSelect").value;
    let displayPlanets=[...planets];
    if(pivot!=="Lagna"){
        let i=displayPlanets.indexOf(pivot);
        if(i!==-1){
            displayPlanets =
                displayPlanets.slice(i)
                .concat(displayPlanets.slice(0,i));
        }
    }

    let html=`
    <div id="table4">
    <h2>Table-5 : Planet ‚Üí Star ‚Üí Sub ‚Üí Sub-Sub</h2>
    `;

    displayPlanets.forEach(p=>{

        let kp=getPlanetKPLords(p);
        if(!kp) return;

        let kpSubKP = getPlanetKPLords(kp.sub);
        let kpSSLKP = getPlanetKPLords(kp.ssl);

        let starOfSub    = kpSubKP  ? kpSubKP.star  : null;
        let starOfSubSub = kpSSLKP  ? kpSSLKP.star  : null;

        let rows=[
            {label:"Planet",planet:p,data:t3[p]},
            {label:"Star Lord",planet:kp.star,data:t3[kp.star]},
            {label:"Sub Lord",planet:kp.sub,data:t3[kp.sub]}
        ];

        html+=`
        <table style="margin-bottom:20px;">
        <tr>
            <th colspan="8" style="font-size:20px;color:#ff9f1c;">
                ${markPlanet(p)}
            </th>
        </tr>
        <tr>
            <th>Entity</th>
			<th>Planet</th>
            <th>Sub</th>
			<th>Sub-Sub</th>
            <th>Star</th>
			<th>Sign</th>
			<th>Placement</th>
			<th>Tara</th>
        </tr>
        `;

        rows.forEach(r=>{
            html+=`
            <tr class="${r.label==='Sub Lord'?'sub-row':''}">
                <td>${r.label}</td>
                <td><b>${markPlanet(r.planet)}</b></td>
                <td class="sub-num">${r.data?.sub||""}</td>
                <td class="ssl-num">${r.data?.ssl||""}</td>
                <td class="star-num">${r.data?.star||""}</td>
                <td>${r.data?.sign||""}</td>
                <td>${r.data?.place||""}</td>
				<td>
				${(() => {
					const janma = resolveTaraJanmaPlanet();
					return computeTaraIndex(janma, r.planet);
				})()}
				</td>

            </tr>`;
        });

        html+=`
        <tr class="sos-row">
            <td>Star of Sub</td>
            <td><b>${markPlanet(starOfSub||"")}</b></td>
            <td class="sub-num">${t3[starOfSub]?.sub||""}</td>
            <td class="ssl-num">${t3[starOfSub]?.ssl||""}</td>
            <td class="star-num">${t3[starOfSub]?.star||""}</td>
            <td>${t3[starOfSub]?.sign||""}</td>
            <td>${t3[starOfSub]?.place||""}</td>
			<td>
			${(() => {
				const janma = resolveTaraJanmaPlanet();
				return computeTaraIndex(janma, starOfSub);
			})()}
			</td>
        </tr>

        <tr class="ssl-row">
            <td>Sub-Sub Lord</td>
            <td><b>${markPlanet(kp.ssl)}</b></td>
            <td class="sub-num">${t3[kp.ssl]?.sub||""}</td>
            <td class="ssl-num">${t3[kp.ssl]?.ssl||""}</td>
            <td class="star-num">${t3[kp.ssl]?.star||""}</td>
            <td>${t3[kp.ssl]?.sign||""}</td>
            <td>${t3[kp.ssl]?.place||""}</td>
			<td>
			${(() => {
				const janma = resolveTaraJanmaPlanet();
				return computeTaraIndex(janma, kp.ssl);
			})()}
			</td>
        </tr>

        <tr class="sossl-row">
            <td>Star of Sub-Sub</td>
            <td><b>${markPlanet(starOfSubSub||"")}</b></td>
            <td class="sub-num">${t3[starOfSubSub]?.sub||""}</td>
            <td class="ssl-num">${t3[starOfSubSub]?.ssl||""}</td>
            <td class="star-num">${t3[starOfSubSub]?.star||""}</td>
            <td>${t3[starOfSubSub]?.sign||""}</td>
            <td>${t3[starOfSubSub]?.place||""}</td>
			<td>
			${(() => {
				const janma = resolveTaraJanmaPlanet();
				return computeTaraIndex(janma, starOfSubSub);
			})()}
			</td>
        </tr>
        </table>`;
    });

    html+=`</div>`;
    document.getElementById("kp-fixed-bottom")
        .insertAdjacentHTML("beforebegin",html);
}

/* =========================================================
   SAFE AUTO REFRESH (UNCHANGED)
   ========================================================= */
(function(){
    const _o=buildTable3;
    buildTable3=function(){
        _o();
        buildTable4();
    };
})();
</script>






























<!-- =========================================================
     TABLE 6
     ========================================================= -->












<!-- =========================================================
     PART 6 : EFFECTIVE LINKS TABLE 6 (UPDATED ‚Äì ROW LEVEL CONTROL)
     (HARD-ANCHORED ‚Äî NEVER MOVES)
     ========================================================= -->
<script>
/* =========================================================
   HELPERS
   ========================================================= */
function nums(str){
    if(!str || str === "") return [];
    return str.split(",").map(Number).filter(n=>n>=1 && n<=12);
}
function uniqueSorted(arr){
    return [...new Set(arr)].sort((a,b)=>a-b);
}
function isEven(n){ return n % 2 === 0; }
function isOdd(n){ return n % 2 === 1; }
function g1(n){ return [1,4,7,10].includes(n); }
function g2(n){ return [2,5,8,11].includes(n); }
function g3(n){ return [3,6,9,12].includes(n); }

/* =========================================================
   COLLECT NUMBERS FROM TABLE-3 CACHE
   ========================================================= */
function collectPlanet(p, useStar, useSSL){
    let T3 = window.__T3_CACHE__;
    if(!T3 || !T3[p]) return [];
    let out = [];
    out.push(...nums(T3[p].sub));
    if(useStar) out.push(...nums(T3[p].star));
    if(useSSL)  out.push(...nums(T3[p].ssl));
    return out;
}

/* =========================================================
   INIT SHELL (ONCE)
   ========================================================= */
function initTable5Shell(){
    const root = document.getElementById("kp-fixed-bottom");
    if(!root || root.querySelector("#table5-shell")) return;

    root.innerHTML = `
    <div id="table5-shell" style="margin-top:40px;">
        <h2>Table-6 Effective Links Table</h2>

        <!-- ROW 1 -->
        <div style="margin-bottom:6px;">
            <label style="margin-right:20px;">
                <input type="checkbox" id="ignoreSSL">
                Ignore Sub-Sub Lord Column
            </label>

            <label style="margin-right:20px;">
                <input type="checkbox" id="ignoreStar" checked>
                Ignore Star Lord Column
            </label>
        </div>

        <!-- ROW 2 -->
        <div style="margin-bottom:6px;">
            <label style="margin-right:20px;">
                <input type="checkbox" id="ignoreSubRow" checked>
                Ignore Sub Lord Row
            </label>

            <label style="margin-right:20px;">
                <input type="checkbox" id="ignoreStarOfSub">
                Ignore Star of Sub
            </label>
        </div>

        <!-- ROW 3 -->
        <div style="margin-bottom:10px;">
            <label style="margin-right:20px;">
                <input type="checkbox" id="ignoreSSLRow" checked>
                Ignore Sub-Sub Lord Row
            </label>

            <label style="margin-right:20px;">
                <input type="checkbox" id="ignoreStarOfSSL" checked>
                Ignore Star of Sub-Sub
            </label>
        </div>

        <div id="table5"></div>
    </div>
    `;

    [
        "ignoreStar",
        "ignoreSSL",
        "ignoreSubRow",
        "ignoreSSLRow",
        "ignoreStarOfSub",
        "ignoreStarOfSSL"
    ].forEach(id=>{
        document.getElementById(id).onchange = buildTable5;
    });
}

/* =========================================================
   PIVOT SORT
   ========================================================= */
function getPivotSortedPlanets(){
    let pivot = document.getElementById("pivotSelect")?.value;
    let list = [...planets];
    if(!pivot || pivot === "Lagna") return list;
    let idx = list.indexOf(pivot);
    if(idx === -1) return list;
    return list.slice(idx).concat(list.slice(0, idx));
}

/* =========================================================
   BUILD TABLE-6 (ROW CORRECT LOGIC + STAR OF SUB ADDED)
   ========================================================= */
function buildTable5(){

    initTable5Shell();

    let T3 = window.__T3_CACHE__;
    if(!T3) return;

    let useStar          = !document.getElementById("ignoreStar").checked;
    let useSSL           = !document.getElementById("ignoreSSL").checked;
    let ignoreSubRow     = document.getElementById("ignoreSubRow").checked;
    let ignoreSSLRow     = document.getElementById("ignoreSSLRow").checked;
    let ignoreStarOfSub  = document.getElementById("ignoreStarOfSub").checked;
    let ignoreStarOfSSL  = document.getElementById("ignoreStarOfSSL").checked;

    let order = getPivotSortedPlanets();

    let html = `
    <table>
        <tr>
            <th>Planet</th>
            <th>Even</th>
            <th>Odd</th>
            <th>1,4,7,10</th>
            <th>2,5,8,11</th>
            <th>3,6,9,12</th>
        </tr>
    `;

    order.forEach(p=>{
        let kp = getPlanetKPLords(p);
        if(!kp) return;

        let all = [];

        /* Planet */
        all.push(...collectPlanet(p, useStar, useSSL));

        /* Star Lord */
        all.push(...collectPlanet(kp.star, useStar, useSSL));

        /* Sub Lord */
        if(!ignoreSubRow){
            all.push(...collectPlanet(kp.sub, useStar, useSSL));
        }

        /* Sub-Sub Lord */
        if(!ignoreSSLRow){
            all.push(...collectPlanet(kp.ssl, useStar, useSSL));
        }

        /* ‚≠ê STAR OF SUB (NEW) */
        if(!ignoreStarOfSub && kp.sub){
            let subKP = getPlanetKPLords(kp.sub);
            if(subKP && subKP.star){
                all.push(...collectPlanet(subKP.star, useStar, useSSL));
            }
        }

        /* ‚≠ê‚≠ê STAR OF SUB-SUB (NEW) */
        if(!ignoreStarOfSSL && kp.ssl){
            let sslKP = getPlanetKPLords(kp.ssl);
            if(sslKP && sslKP.star){
                all.push(...collectPlanet(sslKP.star, useStar, useSSL));
            }
        }

        all = uniqueSorted(all);

        let e=[], o=[], a=[], b=[], c=[];
        all.forEach(n=>{
            if(isEven(n)) e.push(n);
            if(isOdd(n))  o.push(n);
            if(g1(n)) a.push(n);
            if(g2(n)) b.push(n);
            if(g3(n)) c.push(n);
        });

        html += `
        <tr>
            <td><b>${markPlanet(p)}</b></td>

            <td>${e.join(",")}</td>
            <td>${o.join(",")}</td>
            <td>${a.join(",")}</td>
            <td>${b.join(",")}</td>
            <td>${c.join(",")}</td>
        </tr>`;
    });

    html += `</table>`;
    document.getElementById("table5").innerHTML = html;
}

/* =========================================================
   SAFE AUTO CHAIN
   ========================================================= */
(function(){
    const _orig = buildTable4;
    buildTable4 = function(){
        _orig();
        buildTable5();
    };
})();
</script>






















<!-- =========================================================
     TABLE 7
     ========================================================= -->











<!-- =========================================================
     PART 7 : KP TABLE-7 (FINAL STABLE)
     ========================================================= -->
<script>
/* =========================================================
   ASPECT RULES
   ========================================================= */
const aspectRules = {
    Surya:[7], Chandra:[7], Budha:[7], Venus:[7],
    Mangala:[4,7,8],
    Rahu:[5,7,9], Ketu:[5,7,9],
    Jupiter:[5,7,9],
    Saturn:[3,7,10]
};

/* =========================================================
   UTILITIES
   ========================================================= */
function uSort(a){
    return [...new Set(a.map(Number))].sort((x,y)=>x-y);
}

function getAspects(h,p){
    return (aspectRules[p]||[]).map(d=>{
        let x=h+d-1; while(x>12)x-=12; return x;
    });
}

/* =========================================================
   SIGN LORD HOUSES (RAHU/KETU DISPOSITOR LOGIC)
   ========================================================= */
function getSignLordHouses6(p){

    let out=[];

    cuspsData.forEach(c=>{
        if(c.signLord===p){
            out.push(rotateHouse(c.bhava,getPivotHouse()));
        }
    });

    if((p==="Rahu"||p==="Ketu") && out.length===0){
        let s=document.getElementById(p+"_sign").value;
        let disp=signLords[s];
        if(disp){
            cuspsData.forEach(c=>{
                if(c.signLord===disp){
                    out.push(rotateHouse(c.bhava,getPivotHouse()));
                }
            });
            let ph=rotateHouse(getPlanetHouse(disp),getPivotHouse());
            if(document.getElementById("retroMode")?.checked){
                ph=applyRetroPlacement(ph);
            }
            out.push(ph);
        }
    }
    return uSort(out);
}

/* =========================================================
   BUILD TABLE-7
   ========================================================= */
function buildTable6(){

    document.getElementById("table6")?.remove();
    if(!cuspsData || !cuspsData.length) return;

    let pivot = document.getElementById("pivotSelect")?.value;
    let order = [...planets];

    if(pivot && pivot !== "Lagna"){
        let i = order.indexOf(pivot);
        if(i !== -1){
            order = order.slice(i).concat(order.slice(0,i));
        }
    }

    let html = `
    <div id="table6" style="margin-top:40px;">
        <h2>Table-7 : Sign ‚Ä¢ Placement ‚Ä¢ Aspect Synthesis</h2>

        <div style="margin-bottom:12px;">
            <label style="margin-right:20px;">
                <input type="checkbox" id="t6_ignoreSOS" >
                Ignore Star of Sub
            </label>
            <label>
                <input type="checkbox" id="t6_ignoreSOSS" >
                Ignore Star of Sub-Sub
            </label>
        </div>
    `;

    order.forEach(p=>{

        let kp = getPlanetKPLords(p);
        if(!kp) return;

        let chain = [
            {k:"planet", l:"Planet", p:p},
            {k:"star",   l:"Star Lord", p:kp.star},
            {k:"sub",    l:"Sub Lord", p:kp.sub},
            {k:"sos",    l:"Star of Sub", p:getPlanetKPLords(kp.sub)?.star},
            {k:"ssl",    l:"Sub-Sub Lord", p:kp.ssl},
            {k:"sossl",  l:"Star of Sub-Sub", p:getPlanetKPLords(kp.ssl)?.star}
        ];

        html += `
        <table style="margin-bottom:24px;">
            <tr>
                <th colspan="8" style="
                    font-size:20px;
                    font-weight:700;
                    color:#ff9f1c;
                    background:linear-gradient(180deg,#2a0f0f,#140707);
                    padding:12px;
                    border-bottom:2px solid #a86b17;
                ">
                    ${markPlanet(p)}
                </th>
            </tr>
            <tr>
                <th>Entity</th>
                <th>Planet</th>
                <th>Sign Lord</th>
                <th>Placed</th>
                <th>Final</th>
                <th>Aspects</th>
                <th>Summation</th>
                <th>Tara</th>
            </tr>
        `;

        chain.forEach(r=>{
            if(!r.p) return;

            let signH = getSignLordHouses6(r.p);

            let placed = rotateHouse(
                getPlanetHouse(r.p),
                getPivotHouse()
            );

            if(document.getElementById("retroMode")?.checked){
                placed = applyRetroPlacement(placed);
            }

            let fin = uSort([...signH, placed]);
            let asp = uSort(getAspects(placed, r.p));
            let sum = uSort([...fin, ...asp]);

            html += `
            <tr class="t6row ${r.k}">
                <td>${r.l}</td>
                <td>${r.k === "star" ? r.p : markPlanet(r.p)}</td>
                <td>${signH.join(",")}</td>
                <td>${placed}</td>
                <td>${fin.join(",")}</td>
                <td>${asp.join(",")}</td>
                <td>${sum.join(",")}</td>
                <td>
                    ${computeTaraIndex(
                        resolveTaraJanmaPlanet(),
                        r.p
                    )}
                </td>
            </tr>`;
        });

        html += `</table>`;
    });

    html += `</div>`;
    document.getElementById("table5-shell")
        ?.insertAdjacentHTML("afterend", html);

    /* ---------- IGNORE HANDLERS ---------- */
    function applyIgnore(){
        let igSOS  = document.getElementById("t6_ignoreSOS").checked;
        let igSOSS = document.getElementById("t6_ignoreSOSS").checked;

        document.querySelectorAll(".sos td").forEach(td=>{
            td.style.visibility = igSOS ? "hidden" : "visible";
        });

        document.querySelectorAll(".sossl td").forEach(td=>{
            td.style.visibility = igSOSS ? "hidden" : "visible";
        });
    }

    document.getElementById("t6_ignoreSOS").onchange = applyIgnore;
    document.getElementById("t6_ignoreSOSS").onchange = applyIgnore;

    applyIgnore();
}


/* =========================================================
   SAFE AUTO-CHAIN
   ========================================================= */
(function(){
    const _orig=buildTable5;
    buildTable5=function(){
        _orig();
        buildTable6();
    };
})();
</script>


















<!-- üîí PERMANENT BOTTOM CONTAINER FOR EFFECTIVE LINKS -->
<div id="kp-fixed-bottom"></div>
















<!-- =========================================================
     VIMSHOTTARI TABLE
     ========================================================= -->





<!-- VIMSHOTTARI START -->
<div id="vimshottari-wrapper">
<h2>Vimshottari Dasha Age Calculator</h2>



<style>
/* ===== ORIGINAL SUPERB STYLING (UNCHANGED) ===== */
#vimshottari-wrapper{
  background:#0b0f14;
  color:#f5e9c6;
  font-family:Segoe UI,Arial,sans-serif;
  padding:20px;
  margin-top:40px;
}
#vimshottari-wrapper h2,
#vimshottari-wrapper h3{
  color:#facc15;
  text-shadow:0 0 6px #b45309;
}
#vimshottari-wrapper select,
#vimshottari-wrapper input,
#vimshottari-wrapper button{
  background:#111827;
  color:#f5e9c6;
  border:1px solid #ca8a04;
  padding:6px 8px;
  margin:4px;
  border-radius:6px;
  font-weight:600;
}
#vimshottari-wrapper button{cursor:pointer}
#vimshottari-wrapper button:hover{background:#1f2937}
#vimshottari-wrapper hr{
  border:0;border-top:1px solid #ca8a04;margin:16px 0
}
.dasha-node{
  margin-left:14px;
  border-left:1px solid #7c6f3d;
  padding-left:8px;
}
.dasha-header{
  cursor:pointer;
  padding:6px 8px;
  border-radius:6px;
}
.active.level-1 > .dasha-header{
  background:#facc15;color:#1f2937;border:2px solid #ca8a04;
  box-shadow:0 0 12px #facc15;
}
.active.level-2 > .dasha-header{
  background:#38bdf8;color:#082f49;border:2px solid #0284c7;
}
.active.level-3 > .dasha-header{
  background:#4ade80;color:#052e16;border:2px solid #16a34a;
}
.active.level-4 > .dasha-header{
  background:#fbbf24;color:#422006;border:2px solid #d97706;
}
.active.level-5 > .dasha-header{
  background:#eab308;color:#422006;border:2px solid #a16207;
}
.small{font-size:13px;opacity:.9}
.age-box{
  margin-left:10px;
  font-weight:700;
  color:#4ade80;
}
</style>

<div>
  <button onclick="generateVimMoon()">Generate from Moon</button>
  <button onclick="generateVimLagna()">Generate from Lagna</button>
  <span id="nativeAge" class="age-box"></span>
</div>

<hr>
<div id="tree"></div>
<hr>

<h3>Event Analyzer</h3>
<div><button onclick="clearVim()">Clear All</button></div>
<div id="events"></div>

<script>
/* ===== CONSTANTS (UNCHANGED) ===== */
const ORDER=["Ketu","Venus","Surya","Chandra","Mangala","Rahu","Jupiter","Saturn","Budha"];
const YEARS={Ketu:7,Venus:20,Surya:6,Chandra:10,Mangala:7,Rahu:18,Jupiter:16,Saturn:19,Budha:17};
const LEVELS=["Mahadasha","Bhukti","Antara","Sookshma","Prana"];
const MS_YEAR=365.2425*24*60*60*1000;
const NAK_LEN=13+20/60;

let lastExpanded=false;

/* ===== AGE (Y M D ‚Äì AUTHORITATIVE) ===== */
function diffYMD(from,to){
  if(!from||to<from)return "";
  let d=to-from;
  let y=Math.floor(d/MS_YEAR);d-=y*MS_YEAR;
  let m=Math.floor(d/(30.4375*24*60*60*1000));
  let da=Math.floor((d%(30.4375*24*60*60*1000))/(24*60*60*1000));
  return `${y} years ${m} months ${da} days`;
}

/* ===== DEGREE FROM KP PROJECT ===== */
function moonAbs(){
  return absoluteDeg(
    signs.indexOf(Chandra_sign.value),
    Chandra_deg.value,Chandra_min.value,Chandra_sec.value
  );
}
function lagnaAbs(){
  return absoluteDeg(
    signs.indexOf(c1_sign.value),
    c1_deg.value,c1_min.value,c1_sec.value
  );
}

/* ===== TRUE START FROM DEGREE ===== */
function getStart(abs,dob){
  let i=Math.floor(abs/NAK_LEN)%9;
  let lord=ORDER[i];
  let elapsed=(abs%NAK_LEN)/NAK_LEN*YEARS[lord];
  let start=new Date(dob.getTime()-elapsed*MS_YEAR);
  return{lord,start};
}

/* ===== CORE ENGINE (UNCHANGED) ===== */
function addYears(d,y){return new Date(d.getTime()+y*MS_YEAR)}
function rotate(p){let i=ORDER.indexOf(p);return ORDER.slice(i).concat(ORDER.slice(0,i))}
function genLevel(l,s,p,y,m){
  if(l>m)return[];
  let a=[],c=new Date(s);
  rotate(p).forEach(x=>{
    let yy=y*(YEARS[x]/120),e=addYears(c,yy);
    a.push({level:l,planet:x,start:new Date(c),end:new Date(e),
      children:genLevel(l+1,c,x,yy,m)});
    c=e;
  });
  return a;
}

/* ===== RENDER (FIXED AGE FOR FIRST MAHADASHA) ===== */
function render(n,dob){
  let w=document.createElement("div");
  w.className="dasha-node level-"+n.level;
  w.dataset.s=n.start;w.dataset.e=n.end;w.dataset.l=n.level;

  let h=document.createElement("div");
  h.className="dasha-header";
  h.innerHTML=`<b>${LEVELS[n.level-1]} ‚Äì ${n.planet}</b> |
  ${n.start.toISOString().slice(0,10)}
  (Age ${diffYMD(dob,n.start)})
  ‚Üí ${n.end.toISOString().slice(0,10)}
  (Age ${diffYMD(dob,n.end)})`;

  let c=document.createElement("div");c.style.display="none";
  n.children.forEach(ch=>c.appendChild(render(ch,dob)));

  h.onclick=()=>{
    w.classList.toggle("active");
    c.style.display=w.classList.contains("active")?"block":"none";
  };

  w.appendChild(h);w.appendChild(c);return w;
}

/* ===== GENERATORS ===== */
function generateFrom(abs){
  tree.innerHTML="";
  let dob=new Date(baseDate.value);
  nativeAge.textContent="Age of Native : "+diffYMD(dob,new Date());
  let s=getStart(abs,dob);
  let cur=new Date(s.start);
  rotate(s.lord).forEach(p=>{
    let e=addYears(cur,YEARS[p]);
    tree.appendChild(render({
      level:1,planet:p,start:new Date(cur),end:new Date(e),
      children:genLevel(2,cur,p,YEARS[p],3)
    },dob));
    cur=e;
  });
  buildEvents();
}
function generateVimMoon(){generateFrom(moonAbs())}
function generateVimLagna(){generateFrom(lagnaAbs())}

/* ===== EVENTS (100% ORIGINAL) ===== */
function buildEvents(){
  let today=new Date().toISOString().slice(0,10);
  let html=`
  <div>
    <button onclick="setToday()">Current Transit</button>
    <input type="date" id="ed0" value="${today}">
    <button onclick="findEvent(0)">Find</button>
    <span id="er0" class="small"></span>
  </div>`;
  for(let i=1;i<=5;i++){
    html+=`
    <div>
      <input id="en${i}" placeholder="Event name">
      <input type="date" id="ed${i}">
      <button onclick="findEvent(${i})">Find</button>
      <span id="er${i}" class="small"></span>
    </div>`;
  }
  events.innerHTML=html;
}
function setToday(){ed0.value=new Date().toISOString().slice(0,10)}
function findEvent(i){
  let r=er0;
  if(lastExpanded){
    document.querySelectorAll(".active").forEach(a=>a.classList.remove("active"));
    document.querySelectorAll(".dasha-node > div:nth-child(2)")
      .forEach(d=>d.style.display="none");
    r.textContent="";lastExpanded=false;return;
  }
  let d=new Date(document.getElementById(`ed${i}`).value);
  let n=[...document.querySelectorAll(".dasha-node")]
    .filter(x=>d>=new Date(x.dataset.s)&&d<new Date(x.dataset.e))
    .sort((a,b)=>a.dataset.l-b.dataset.l);
  n.forEach(x=>{x.classList.add("active");x.children[1].style.display="block"});
  r.textContent=n.map(x=>x.querySelector("b").textContent.split(" ‚Äì ").pop()).join(" ‚Äì ");
  lastExpanded=true;
}
function clearVim(){
  tree.innerHTML="";events.innerHTML="";
  nativeAge.textContent="";lastExpanded=false;
}
</script>



</div>
<!-- VIMSHOTTARI END -->
















<!-- =========================================================
     SWISS EPHEMERIS
     ========================================================= -->






<script>
/* =========================================================
   SWISS EPHEMERIS JSON LOADER (UNIVERSAL FORMAT)
   SUPPORTS:
   - meta
   - lagna (absolute degree)
   - planets { absolute degrees }
   - cusps { 1..12 absolute degrees }
   ========================================================= */

/* ---------- ABS DEG ‚Üí SIGN + DMS ---------- */
function absToDMS(abs){
    abs = ((abs % 360) + 360) % 360;

    let signIndex = Math.floor(abs / 30) + 1;
    let inside = abs % 30;

    let deg = Math.floor(inside);
    let minF = (inside - deg) * 60;
    let min = Math.floor(minF);
    let sec = Math.round((minF - min) * 60);

    if(sec === 60){ sec = 0; min++; }
    if(min === 60){ min = 0; deg++; }
    if(deg === 30){ deg = 0; signIndex++; }
    if(signIndex > 12) signIndex = 1;

    return { signIndex, deg, min, sec };
}

/* ---------- APPLY ABS TO INPUTS ---------- */
function writeToInputs(prefix, abs){
    let d = absToDMS(abs);

    document.getElementById(prefix + "_sign").selectedIndex = d.signIndex;
    document.getElementById(prefix + "_deg").value = d.deg;
    document.getElementById(prefix + "_min").value = d.min;
    document.getElementById(prefix + "_sec").value = d.sec;
}

/* =========================================================
   LOAD SWISS JSON
   ========================================================= */
function loadSwissJSON(){

    let f = document.createElement("input");
    f.type = "file";
    f.accept = "application/json";

    f.onchange = e => {

        let r = new FileReader();
        r.onload = () => {

            let data = JSON.parse(r.result);
			window.__LAST_SWISS_KP__ = data;


            /* ---------- PERSON NAME ---------- */
            if(data.meta?.name){
                document.getElementById("personName").value =
                    data.meta.name.toUpperCase();
            }

            /* ---------- DATE & TIME (UTC SAFE) ---------- */
            if(data.meta?.datetime_utc){
                let dt = new Date(data.meta.datetime_utc);
                baseDate.value = dt.toISOString().slice(0,10);
                baseTimeLock.value = dt.toTimeString().slice(0,8);
                BASE_EPOCH = null;
                lockBaseDateTime();
            }

            /* ---------- FORCE MANUAL MODE ---------- */
            manualMode.checked = true;
            manualMode.onchange();

            /* ---------- LAGNA ---------- */
            if(typeof data.lagna === "number"){
                writeToInputs("c1", data.lagna);
            }

            /* ---------- CUSPS ---------- */
            if(data.cusps){
                for(let i=1;i<=12;i++){
                    if(typeof data.cusps[i] === "number"){
                        writeToInputs("c"+i, data.cusps[i]);
                    }
                }
            }

            /* ---------- PLANETS ---------- */
            if(data.planets){

			Object.keys(data.planets).forEach(p=>{

				/* ‚ùå skip nodes here (handled separately) */
				if(p === "Rahu" || p === "Ketu") return;
				if(p.endsWith("_true")) return;

				if(
					document.getElementById(p+"_sign") &&
					typeof data.planets[p] === "number"
				){
					writeToInputs(p, data.planets[p]);
				}
			});

			/* üî• APPLY NODE MODE AFTER LOAD */
			applyNodeModeKP();
		}


            /* ---------- FINAL REFRESH ---------- */
            buildCuspalChart();
            drawD1();
        };

        r.readAsText(e.target.files[0]);
    };

    f.click();
}









function applyNodeModeKP(){


	    /* üî• SYNC WITH CHECKBOX STATE */
    const chk = document.getElementById("trueNodeModeKP");
    if(chk){
        USE_TRUE_NODE_KP = chk.checked;
    }

    const data = window.__LAST_SWISS_KP__;
    if(!data || !data.planets) return;

    let rahuKey = USE_TRUE_NODE_KP ? "Rahu_true" : "Rahu";
    let ketuKey = USE_TRUE_NODE_KP ? "Ketu_true" : "Ketu";

    if(typeof data.planets[rahuKey] === "number"){
        writeToInputs("Rahu", data.planets[rahuKey]);
    }

    if(typeof data.planets[ketuKey] === "number"){
        writeToInputs("Ketu", data.planets[ketuKey]);
    }

    buildCuspalChart();
    drawD1();
}








document.getElementById("trueNodeModeKP")
  ?.addEventListener("change", e => {

    USE_TRUE_NODE_KP = e.target.checked;
    applyNodeModeKP();

});









</script>
















</body>
</html>




